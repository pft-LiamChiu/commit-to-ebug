#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

usage() {
  cat <<'EOF'
Usage:
  git ebug [commit]

Description:
  Send the latest ebug commit (or a specified commit) to n8n webhook.
  Only commits with message starting with:
    [what] ebug:
  will be sent.

Arguments:
  commit        Optional. Commit hash (short or full).
                If omitted, use HEAD.

Configuration:
  Config file (next to this script):
    .env.n8n

  Required variables:
    N8N_URL
    N8N_SECRET
    U_MESSENGER_EMAIL

Examples:
  git ebug
  git ebug 3a1f9c2
  git ebug HEAD~1

Notes:
  - Short commit hashes must be unique.
  - Detached HEAD will be skipped.
  - HTTPS is strongly recommended for N8N_URL.

Commit Message Format:
  The commit message must follow this format:
    [what] ebug:xxx

    [why]

    [how]

    @reviewer
EOF
}

if [[ "${1:-}" == "-h" ]]; then
  usage
  exit 0
fi

# å˜—è©¦è¼‰å…¥ .env æª”æ¡ˆ (å¦‚æœå­˜åœ¨)
if [ -f "$SCRIPT_DIR/.env.n8n" ]; then
  source "$SCRIPT_DIR/.env.n8n"
fi

echo "[fill-ebug] æª¢æŸ¥å¿…è¦è¨­å®šâ€¦"

# æª¢æŸ¥å¿…è¦ç’°å¢ƒè®Šæ•¸
missing=()
[[ -z "${N8N_URL:-}" ]] && missing+=("N8N_URL")
[[ -z "${N8N_SECRET:-}" ]] && missing+=("N8N_SECRET")
[[ -z "${U_MESSENGER_EMAIL:-}" ]] && missing+=("U_MESSENGER_EMAIL")
[[ -z "${HMAC_SECRET:-}" ]] && missing+=("HMAC_SECRET")

if (( ${#missing[@]} > 0 )); then
  echo "âŒ éŒ¯èª¤ï¼šç¼ºå°‘ç’°å¢ƒè®Šæ•¸æˆ– .env è¨­å®šï¼š"
  for var in "${missing[@]}"; do echo "   - $var"; done
  exit 1
fi

# å®‰å…¨æª¢æŸ¥ï¼šç¢ºä¿ä½¿ç”¨ HTTPS
if [[ ! "$N8N_URL" =~ ^https:// ]]; then
  echo "âš ï¸ è­¦å‘Šï¼šN8N_URL ä¸æ˜¯ä½¿ç”¨ HTTPSï¼Œå‚³è¼¸éç¨‹å¯èƒ½ä¸å®‰å…¨ï¼"
fi

escape_string() {
  echo -n "$1" \
    | sed ':a;N;$!ba;s/\n/\\n/g' \
    | sed 's/"/\\"/g'
}

notify_n8n_latest() {
  local sha="$1"
  local repo_url branch_name body escaped_msg
  repo_url="$(git config --get remote.origin.url || true)"
  branch_name="$(git symbolic-ref --quiet --short HEAD || true)"

  if [[ -z "$branch_name" ]]; then
    echo "[fill-ebug] âŒ detached HEADï¼Œç•¥é"
    exit 0
  fi

  body="$(git log -1 --pretty=%B "$sha")"
  if [[ ! "$body" =~ ^\[what\][[:space:]]+ebug: ]]; then
  echo "[fill-ebug] â­ commit message é ebug é–‹é ­ï¼Œç•¥éé€šçŸ¥"
  return 0
  fi
  escaped_msg="$(escape_string "$body")"

  local author_name author_email author_date committer_name committer_email committer_date
  author_name=$(git log -1 --pretty=%an "$sha")
  author_email=$(git log -1 --pretty=%ae "$sha")
  author_date=$(git log -1 --pretty=%aI "$sha")
  committer_name=$(git log -1 --pretty=%cn "$sha")
  committer_email=$(git log -1 --pretty=%ce "$sha")
  committer_date=$(git log -1 --pretty=%cI "$sha")

local json_body
json_body=$(cat <<EOF
{
"repo_url": "$repo_url",
"branch": "$branch_name",
"hash": "$sha",
"commit_message": "$escaped_msg",
"author_name": "$author_name",
"author_email": "$author_email",
"author_date": "$author_date",
"committer_name": "$committer_name",
"committer_email": "$committer_email",
"committer_date": "$committer_date",
"receiver_email": "$U_MESSENGER_EMAIL"
}
EOF
)

  echo "[fill-ebug] â†’ Notify n8n: $sha"

  TIMESTAMP=$(date +%s)
  NONCE=$(openssl rand -hex 16)

  tmp_body="$(mktemp)"
  printf "%s" "$json_body" > "$tmp_body"

  tmp_hmac_data="$(mktemp)"
  {
    echo -n "$TIMESTAMP"
    echo -n "$NONCE"
    cat "$tmp_body"
  } > "$tmp_hmac_data"

  SIGNATURE="$(openssl dgst -sha256 -hmac "$HMAC_SECRET" "$tmp_hmac_data" | sed 's/^.* //')"

  response=$(curl -sS -X POST "$N8N_URL" \
    -H "Content-Type: application/json" \
    -H "X-Timestamp: $TIMESTAMP" \
    -H "N8N-Webhook-Secret: $N8N_SECRET" \
    -H "X-Nonce: $NONCE" \
    -H "X-Signature: $SIGNATURE" \
    --data-binary @"$tmp_body" \
    -w "\nHTTP_STATUS:%{http_code}" \
    2>&1) || {
      echo "[fill-ebug] âŒ curl åŸ·è¡Œå¤±æ•—"
      echo "$response"
      exit 1
    }

  http_status=$(echo "$response" | sed -n 's/.*HTTP_STATUS://p')
  body_resp=$(echo "$response" | sed 's/HTTP_STATUS:.*//')

  if [[ "${http_status:-0}" -ge 400 ]]; then
    echo "[fill-ebug] âŒ n8n å›å‚³éŒ¯èª¤ (HTTP $http_status)"
    echo "Response body:"
    echo "$body_resp"
    exit 1
  fi
}

if [[ $# -ge 1 ]]; then
  input_sha="$1"

  if ! resolved_sha="$(git rev-parse --verify "${input_sha}^{commit}" 2>/dev/null)"; then
    echo "[fill-ebug] âŒ commit hash ä¸å­˜åœ¨æˆ–ä¸å”¯ä¸€ï¼š$input_sha"
    echo "[fill-ebug] ğŸ’¡ è«‹è¼¸å…¥æ›´é•·çš„ commit hash"
    exit 1
  fi
else
  resolved_sha="$(git rev-parse HEAD)"
fi

notify_n8n_latest "$resolved_sha"

exit 0
